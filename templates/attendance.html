{% extends "base.html" %}
{% block content %}

<div class="container mt-5">

    <!-- HEADER -->
    <div class="text-center mb-5">
        <h1 class="fw-bold">Face Attendance System</h1>
        <p class="text-muted">Work Session Dashboard</p>
    </div>

    <!-- SUMMARY CARDS -->
    <div class="row text-center mb-5 g-4">

        <div class="col-md-3">
            <div class="summary-box">
                <h6>Total Users</h6>
                <h2>{{ total_users }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="summary-box">
                <h6>Today's Attendance</h6>
                <h2>{{ today_count }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="summary-box">
                <h6>Total Sessions</h6>
                <h2>{{ total_count }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="summary-box">
                <h6>Attendance %</h6>
                <h2>{{ percentage }}%</h2>
            </div>
        </div>

    </div>

    <!-- HISTORY HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-semibold mb-0">Attendance History</h4>

        <div class="d-flex gap-2">

            <input type="text"
                   id="searchInput"
                   class="form-control"
                   placeholder="Search Employee ID"
                   style="max-width:200px;">

            <input type="date"
                   id="dateFilter"
                   class="form-control"
                   style="max-width:200px;">

            <button class="btn btn-outline-danger"
                    onclick="bulkDelete()">
                Delete Selected
            </button>

            <a href="/download/pdf" class="btn btn-primary">
                Download Report
            </a>

        </div>
    </div>

    <div class="divider mb-4"></div>

    <!-- TABLE -->
    <div class="table-responsive mb-5">
        <table class="table modern-table align-middle">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Employee ID</th>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Check-In</th>
                    <th>Check-Out</th>
                    <th>Worked Hours</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="attendanceTable">
            {% for row in rows %}
                <tr>
                    <td>
                        <input type="checkbox"
                               class="recordCheckbox"
                               value="{{ row[0] }}">
                    </td>
                    <td>{{ row[1] }}</td>
                    <td>{{ row[2] }}</td>
                    <td>{{ row[3] }}</td>
                    <td>{{ row[4] if row[4] else '-' }}</td>
                    <td>{{ row[5] if row[5] else '-' }}</td>
                    <td>
                        {% if row[6] %}
                            <span class="badge bg-success">
                                {{ "%.2f"|format(row[6]) }} hrs
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <a href="/admin/delete_attendance/{{ row[0] }}"
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('Delete this record?')">
                            Delete
                        </a>

                        <a href="/admin/delete_employee_attendance/{{ row[1] }}"
                           class="btn btn-sm btn-warning"
                           onclick="return confirm('Delete all records of this employee?')">
                            Delete All
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- CHARTS -->
    <div class="row mt-5 g-4">

        <div class="col-md-6">
            <div class="chart-box p-4">
                <h5 class="text-center mb-3">Daily Attendance Trend</h5>
                <canvas id="dailyChart"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="chart-box p-4">
                <h5 class="text-center mb-3">Recognition Performance</h5>
                <canvas id="perfChart"></canvas>
            </div>
        </div>

    </div>

</div>

<script>

/* ================= SEARCH FILTER ================= */
document.getElementById("searchInput")
.addEventListener("keyup", function() {
    const value = this.value.toLowerCase();
    document.querySelectorAll("#attendanceTable tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(value)
            ? ""
            : "none";
    });
});

/* ================= SELECT ALL ================= */
document.getElementById("selectAll")
.addEventListener("change", function(){
    document.querySelectorAll(".recordCheckbox")
    .forEach(cb => cb.checked = this.checked);
});

/* ================= BULK DELETE ================= */
function bulkDelete(){

    const selected = Array.from(
        document.querySelectorAll(".recordCheckbox:checked")
    ).map(cb => cb.value);

    if(selected.length === 0){
        alert("No records selected");
        return;
    }

    if(confirm("Delete selected records?")){
        fetch("/admin/bulk_delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids: selected })
        }).then(()=> location.reload());
    }
}

/* ================= DAILY CHART ================= */
fetch("/stats/daily")
.then(r => r.json())
.then(data => {
    new Chart(document.getElementById("dailyChart"), {
        type: "line",
        data: {
            labels: data.map(d => d[0]),
            datasets: [{
                label: "Attendance",
                data: data.map(d => d[1]),
                borderWidth: 2,
                tension: 0.4,
                fill: false
            }]
        }
    });
});

/* ================= SUCCESS / FAILURE ================= */
fetch("/stats/performance")
.then(r => r.json())
.then(data => {
    new Chart(document.getElementById("perfChart"), {
        type: "bar",
        data: {
            labels: ["Success", "Failure"],
            datasets: [{
                label: "Recognition Count",
                data: [data.success, data.failure]
            }]
        }
    });
});

</script>

{% endblock %}
