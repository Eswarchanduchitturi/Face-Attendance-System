{% extends "base.html" %}
{% block content %}

<div class="container mt-5">

    <div class="text-center mb-5">
        <h1 class="fw-bold">Face Attendance System</h1>
        <p class="text-muted">Employee Face Enrollment</p>
    </div>

    <!-- FORM -->
    <div class="row justify-content-center">
        <div class="col-md-5">

            <form id="enrollForm">

                <input type="number" name="user_id"
                       class="form-control mb-3"
                       placeholder="Employee ID" required>

                <input type="text" name="name"
                       class="form-control mb-3"
                       placeholder="Full Name" required>

                <button class="btn btn-primary w-100">
                    Start Enrollment
                </button>

            </form>

        </div>
    </div>

</div>


<!-- ================= FULLSCREEN ENROLLMENT MODAL ================= -->
<div id="enrollOverlay" class="enroll-overlay d-none">

    <div class="enroll-box text-center">

        <img id="stepImage"
             src=""
             class="enroll-image mb-4">

        <h4 id="stepTitle"></h4>

        <div class="progress mt-4">
            <div id="progressBar"
                 class="progress-bar bg-dark"
                 style="width:0%"></div>
        </div>

    </div>

</div>


<script>

const steps = [
    {
        title: "Camera Initialization",
        image: "/static/images/enroll_steps/camera.gif",
        progress: 10
    },
    {
        title: "Sample Image Collection (50 Images)",
        image: "/static/images/enroll_steps/capture.gif",
        progress: 30
    },
    {
        title: "Image Preprocessing",
        image: "/static/images/enroll_steps/preprocess.png",
        progress: 50
    },
    {
        title: "Feature Extraction (LBPH)",
        image: "/static/images/enroll_steps/lbph.png",
        progress: 70
    },
    {
        title: "Model Training",
        image: "/static/images/enroll_steps/training.gif",
        progress: 90
    },
    {
        title: "Model Saved Successfully",
        image: "/static/images/enroll_steps/success.gif",
        progress: 100
    }
];


document.getElementById("enrollForm").onsubmit = async function(e){

    e.preventDefault();

    const form = new FormData(e.target);
    const userId = form.get("user_id");

    document.getElementById("enrollOverlay").classList.remove("d-none");

    for(let i = 0; i < steps.length; i++){

        document.getElementById("stepImage").src = steps[i].image;
        document.getElementById("stepTitle").innerText = steps[i].title;
        document.getElementById("progressBar").style.width =
            steps[i].progress + "%";

        await new Promise(r => setTimeout(r, 1500));
    }

    // Backend capture + training
    await fetch("/enroll", { method:"POST", body: form });
    await fetch(`/capture/${userId}`);
    await fetch("/train_test_progress");

    setTimeout(()=>{
        document.getElementById("enrollOverlay").classList.add("d-none");
        showTopToast("Enrollment Completed Successfully âœ…");
    }, 1000);
};

</script>

{% endblock %}
