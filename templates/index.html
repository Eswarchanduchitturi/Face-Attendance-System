{% extends "base.html" %}
{% block content %}

<div class="container mt-5">

    <!-- HEADER -->
    <div class="text-center mb-5">
        <h1 class="fw-bold">Face Attendance System</h1>
        <p class="text-muted">Smart Check-In & Check-Out Recognition</p>
    </div>

    <!-- CAMERA SECTION -->
    <div class="text-center">

        <!-- CAMERA CARD -->
<div class="camera-card mx-auto mb-4">

    <img id="videoFeed"
         class="camera-feed d-none"
         alt="Live Camera" />

    <div id="cameraPlaceholder" class="camera-placeholder">
        <i class="fa-solid fa-video fa-2x mb-2"></i>
        <div>Camera Preview</div>
    </div>

</div>


        <!-- SCAN STATUS -->
        <p id="scanStatus" class="text-muted fw-semibold mb-4">
            Camera is OFF
        </p>

        <!-- BUTTONS -->
        <div class="d-flex justify-content-center gap-3">
            <button class="btn btn-primary" onclick="cameraOn()">
                Start Camera
            </button>
            <button class="btn btn-secondary" onclick="cameraOff()">
                Stop Camera
            </button>
        </div>

    </div>

</div>

<script>

let attendanceInterval = null;

/* ================= CAMERA ON ================= */
async function cameraOn() {

    await fetch("/camera/on");

    const img = document.getElementById("videoFeed");
    const placeholder = document.getElementById("cameraPlaceholder");

    img.src = "/video";
    img.classList.remove("d-none");
    placeholder.style.display = "none";

    document.getElementById("scanStatus").innerText =
        "Scanning... Please look at the camera";

    startAttendanceCheck();
}

/* ================= CAMERA OFF ================= */
async function cameraOff() {

    await fetch("/camera/off");

    const img = document.getElementById("videoFeed");
    const placeholder = document.getElementById("cameraPlaceholder");

    img.src = "";
    img.classList.add("d-none");
    placeholder.style.display = "flex";

    document.getElementById("scanStatus").innerText =
        "Camera is OFF";

    stopAttendanceCheck();
}

/* ================= START POLLING ================= */
function startAttendanceCheck() {

    if (attendanceInterval) return;

    attendanceInterval = setInterval(async () => {

        const res = await fetch("/attendance_status");
        const data = await res.json();

        if (!data.status) return;

        handleAttendanceStatus(data.status);

    }, 5000);
}

/* ================= STOP POLLING ================= */
function stopAttendanceCheck() {
    if (attendanceInterval) {
        clearInterval(attendanceInterval);
        attendanceInterval = null;
    }
}

/* ================= HANDLE STATUS ================= */
function handleAttendanceStatus(status){

    if (status === "checkin_success") {

        showTopToast("Attendance Marked Successfully ✅");
        stopAttendanceCheck();
    }

    else if (status.startsWith("checkout_success")) {

        const hrs = status.split("_")[2];
        showTopToast("Checked Out ✔ Worked: " + hrs + " hrs");
        stopAttendanceCheck();
    }

    else if (status === "already_checked_in") {

        showTopToast("Already Checked-In Today");
    }

    else if (status === "already_checked_out") {

        showTopToast("Already Checked-Out Today");
    }

    else if (status === "failed") {

        showTopToast("Recognition Failed ❌");
    }
}

</script>

{% endblock %}
